<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendrier de Garde Altern√©e</title>
    <style>
        /* D√©finition des variables CSS pour les couleurs (couleurs par d√©faut) */
        :root {
            /* Couleurs Standard */
            --color-a-bg: #add8e6;    /* Bleu clair */
            --color-b-bg: #90ee90;    /* Vert clair */
            
            /* Couleurs Vacances */
            --color-va-bg: #f7a9a8;   /* Rouge ros√© */
            --color-va-border: #e74c3c;
            --color-vb-bg: #a8d5f7;   /* Bleu ciel */
            --color-vb-border: #3498db;
            
            /* Couleurs de Texte */
            --color-text-light: #333;
        }

        /* üé® Style CSS */
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            padding: 20px;
            background-color: #f4f7f6;
        }

        /* NOUVEAU: Mise en page principale (2 colonnes) */
        .main-container {
            display: flex;
            gap: 20px;
            width: 100%;
            max-width: 1400px; /* Augmenter la largeur maximale */
        }

        #config-panel {
            width: 400px; /* Largeur fixe pour le panneau de configuration */
            flex-shrink: 0;
            transition: margin-left 0.3s ease-in-out;
        }

        .calendar-display {
            flex-grow: 1;
            background-color: #fff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            padding: 20px;
        }
        
        .config-header {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: #e9ecef;
        }
        
        /* Grilles internes de configuration */
        .standard-config {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }
        .cycle-config {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        /* Configuration des vacances (Mise √† jour pour un alignement propre) */
        .holiday-input-group {
            display: flex;
            align-items: flex-end; /* Alignez tout au bas des champs (pour le bouton) */
            gap: 10px;
            margin-top: 10px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #ccc;
        }
        
        /* Nouveau style pour les champs individuels */
        .holiday-input-group .input-item {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }

        /* Ajustement du bouton pour qu'il s'aligne avec les autres champs */
        .holiday-input-group .add-button {
            padding: 8px 15px;
            height: 35px; /* Ajuster la hauteur pour qu'elle corresponde aux inputs */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .school-year-config {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #ccc;
        }
        .color-picker-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
            margin-bottom: 20px;
        }

        .config-header label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }

        .config-header input[type="date"], 
        .config-header input[type="text"], 
        .config-header input[type="number"], 
        .config-header select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            width: 100%;
            box-sizing: border-box;
        }
        .config-header input[type="color"] {
            width: 100%;
            height: 35px;
            padding: 0;
            border: none;
            cursor: pointer;
        }

        .config-header button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            white-space: nowrap;
        }

        /* En-t√™te du calendrier (vue un mois) */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px 0;
            border-bottom: 2px solid #3498db;
        }

        .calendar-header button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 16px;
        }

        .calendar-header h2 {
            margin: 0;
            color: #333;
        }

        /* TABLEAU UNIQUE (vue un mois) */
        #calendar-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        /* CONTENEUR ANNEE COMPLETE (vue multi-mois) */
        #full-year-view {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 20px;
        }
        
        .month-calendar {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border-radius: 4px;
            overflow: hidden;
        }

        .month-calendar caption {
            font-weight: bold;
            font-size: 1.2em;
            padding: 8px 0;
            background-color: #3498db;
            color: white;
            border-top-left-radius: 4px;
            border-top-right-radius: 4px;
        }

        #calendar-table th, .month-calendar th {
            background-color: #5dade2;
            color: white;
            padding: 8px;
            font-weight: bold;
        }

        #calendar-table td, .month-calendar td {
            border: 1px solid #eee;
            padding: 6px 3px;
            text-align: center;
            height: 50px; 
            cursor: default;
            transition: background-color 0.2s;
            position: relative; 
            font-size: 0.9em;
        }
        
        /* Couleurs d'alternance standard (Parent A/B) */
        .parent-a { 
            background-color: var(--color-a-bg); 
            color: var(--color-text-light); 
        }
        .parent-b { 
            background-color: var(--color-b-bg); 
            color: var(--color-text-light); 
        }

        /* Couleurs de Vacances (V: Vacances) - Override standard */
        .v-parent-a { 
            background-color: var(--color-va-bg); 
            border: 2px dashed var(--color-va-border); 
            font-weight: bold; 
        }
        .v-parent-b { 
            background-color: var(--color-vb-bg); 
            border: 2px dashed var(--color-vb-border); 
            font-weight: bold; 
        }

        /* Jours hors mois */
        .out-of-month { background-color: #f8f8f8; color: #ccc; }

        /* L√©gende */
        .legend {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
        }

        .color-box {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>

    <div class="main-container">
        
        <div id="config-panel">
            <h1 style="text-align: center; color: #3498db;">üóìÔ∏è Configuration</h1>
            
            <div class="config-header">
                <h3>Param√®tres du Cycle et Noms</h3>
                <div class="standard-config">
                    <div>
                        <label for="nameA">Nom du Parent A :</label>
                        <input type="text" id="nameA" value="Maman" onchange="updateNames()">
                    </div>
                    <div>
                        <label for="nameB">Nom du Parent B :</label>
                        <input type="text" id="nameB" value="Papa" onchange="updateNames()">
                    </div>
                    <div>
                        <label for="refDate">Date de d√©but du cycle (Lundi) :</label>
                        <input type="date" id="refDate" value="2025-01-06" onchange="initCalendar()">
                    </div>
                </div>

                <div class="cycle-config">
                    <div>
                        <label for="weeksA">Dur√©e Parent A (semaines) :</label>
                        <input type="number" id="weeksA" value="2" min="1" onchange="initCalendar()">
                    </div>
                    <div>
                        <label for="weeksB">Dur√©e Parent B (semaines) :</label>
                        <input type="number" id="weeksB" value="2" min="1" onchange="initCalendar()">
                    </div>
                </div>

                <label for="startParent" style="margin-top: 15px;">Parent qui commence le cycle standard :</label>
                <select id="startParent" onchange="initCalendar()" style="width: auto;">
                    <option value="parent-a" id="opt-parent-a">Maman</option>
                    <option value="parent-b" id="opt-parent-b">Papa</option>
                </select>
            </div>

            <div class="config-header" id="holiday-config">
                <h3>Remplacement des P√©riodes de Vacances (50/50)</h3>
                <div class="holiday-input-group">
                    <div class="input-item">
                        <label for="holiday-start">D√©but (inclus) :</label>
                        <input type="date" id="holiday-start">
                    </div>
                    <div class="input-item">
                        <label for="holiday-end">Fin (inclus) :</label>
                        <input type="date" id="holiday-end">
                    </div>
                    <div class="input-item">
                        <label for="holiday-parent">Garde 1√®re moiti√© :</label>
                        <select id="holiday-parent">
                            <option value="parent-a">Parent A</option>
                            <option value="parent-b">Parent B</option>
                        </select>
                    </div>
                    <button onclick="addHoliday()" class="add-button" style="background-color: #2ecc71; color: white;">Ajouter</button>
                </div>
                
                <div id="holiday-list">
                    <p>Aucune p√©riode de vacances d√©finie.</p>
                </div>
            </div>
            
            <div class="config-header">
                <h3>üé® Personnalisation des Couleurs</h3>
                <div class="color-picker-group">
                    <label for="colorA" id="label-colorA">Couleur Parent A :</label>
                    <input type="color" id="colorA" value="#add8e6" onchange="changeColor()">
                    
                    <label for="colorB" id="label-colorB">Couleur Parent B :</label>
                    <input type="color" id="colorB" value="#90ee90" onchange="changeColor()">
                    
                    <label for="colorVA" id="label-colorVA">Couleur Vacances A :</label>
                    <input type="color" id="colorVA" value="#f7a9a8" onchange="changeColor()">
                    
                    <label for="colorVB" id="label-colorVB">Couleur Vacances B :</label>
                    <input type="color" id="colorVB" value="#a8d5f7" onchange="changeColor()">
                </div>
            </div>
            <div class="config-header">
                <h3>Sauvegarde et Restauration (CSV)</h3>
                <button onclick="exportConfig()" style="background-color: #2980b9; color: white; margin-right: 10px;">Exporter la Configuration (CSV)</button>
                <input type="file" id="importFile" accept=".csv" style="display: none;" onchange="importConfig()">
                <button onclick="document.getElementById('importFile').click()" style="background-color: #16a085; color: white;">Importer la Configuration (CSV)</button>
            </div>
        </div>

        <div class="calendar-display">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h1 style="color: #3498db;">Calendrier de Garde</h1>
                <button onclick="toggleConfig()" style="background-color: #f39c12; color: white;">Masquer/Afficher Config</button>
            </div>

            <div class="config-header school-year-config" style="border: none;">
                <label for="schoolYearStart">Ann√©e scolaire de d√©part (ex: 2025-2026) :</label>
                <input type="number" id="schoolYearStart" value="2025" min="2000" style="width: 80px;" onchange="updateSchoolYearView()">
                <button onclick="renderSchoolYear()" style="background-color: #e67e22; color: white; flex-shrink: 0;">Afficher l'ann√©e compl√®te (Juil X - Ao√ªt X+1)</button>
                <button onclick="toggleView('single')" style="background-color: #95a5a6; color: white; flex-shrink: 0;">Afficher le mois actuel</button>
            </div>


            <div id="single-month-view">
                <div class="calendar-header">
                    <button id="prev-month" onclick="changeMonth(-1)"> &lt; Mois Pr√©c√©dent </button>
                    <h2 id="month-year"></h2>
                    <button id="next-month" onclick="changeMonth(1)"> Mois Suivant &gt; </button>
                </div>

                <table id="calendar-table">
                    <thead>
                        <tr>
                            <th>Lun</th><th>Mar</th><th>Mer</th><th>Jeu</th><th>Ven</th><th>Sam</th><th>Dim</th>
                        </tr>
                    </thead>
                    <tbody id="calendar-body">
                        </tbody>
                </table>
            </div>

            <div id="full-year-view" style="display: none;">
                </div>

            <div class="legend">
                <div class="legend-item"><div class="color-box parent-a"></div><span id="legend-name-a">Parent A (standard)</span></div>
                <div class="legend-item"><div class="color-box parent-b"></div><span id="legend-name-b">Parent B (standard)</span></div>
                <div class="legend-item"><div class="color-box v-parent-a"></div><span id="legend-vac-a">Parent A (vacances)</span></div>
                <div class="legend-item"><div class="color-box v-parent-b"></div><span id="legend-vac-b">Parent B (vacances)</span></div>
            </div>
        </div>
    </div>

    <script>
        // üß† Logique JavaScript
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        const MS_PER_DAY = 1000 * 60 * 60 * 24;
        let holidays = []; 
        
        // --- LOGIQUE DE GARDE STANDARD ---
        function getStandardCycleParent(date, refDate, startParentClass) {
            const nameA = document.getElementById('nameA').value || 'Parent A';
            const nameB = document.getElementById('nameB').value || 'Parent B';
            
            const weeksA = parseInt(document.getElementById('weeksA').value) || 1;
            const weeksB = parseInt(document.getElementById('weeksB').value) || 1;

            const daysA = weeksA * 7;
            const cycleLengthDays = daysA + (weeksB * 7);
            
            const diffDays = Math.floor((date.getTime() - refDate.getTime()) / MS_PER_DAY);
            let dayInCycle = diffDays % cycleLengthDays; 
            
            if (dayInCycle < 0) {
                dayInCycle += cycleLengthDays;
            }

            let baseInfo = (dayInCycle >= 0 && dayInCycle < daysA) ? 
                { class: 'parent-a', name: nameA } : 
                { class: 'parent-b', name: nameB };

            if (startParentClass === 'parent-b') {
                if (baseInfo.class === 'parent-a') {
                    return { class: 'parent-b', name: nameB };
                } else {
                    return { class: 'parent-a', name: nameA };
                }
            }

            return baseInfo;
        }
        
        // --- LOGIQUE D'OVERRIDE DE VACANCES ---
        function getHolidayOverride(date) {
            const dateOnly = new Date(date.getFullYear(), date.getMonth(), date.getDate());

            for (const h of holidays) {
                const startTimestamp = h.start.getTime();
                const endTimestamp = h.end.getTime();
                const midTimestamp = h.mid.getTime();
                const dateTimestamp = dateOnly.getTime();

                if (dateTimestamp >= startTimestamp && dateTimestamp <= endTimestamp) {
                    const nameA = document.getElementById('nameA').value || 'Parent A';
                    const nameB = document.getElementById('nameB').value || 'Parent B';
                    
                    const firstParentName = (h.firstHalfParent === 'parent-a' ? nameA : nameB);
                    const secondParentName = (h.firstHalfParent === 'parent-a' ? nameB : nameA);
                    
                    let parentClass;
                    let parentName;
                    
                    if (dateTimestamp < midTimestamp) {
                        parentClass = h.firstHalfParent;
                        parentName = firstParentName + " (Vacances 1/2)";
                    } else {
                        parentClass = (h.firstHalfParent === 'parent-a' ? 'parent-b' : 'parent-a');
                        parentName = secondParentName + " (Vacances 2/2)";
                    }

                    return { 
                        class: 'v-' + parentClass, 
                        name: parentName,
                        isHoliday: true
                    };
                }
            }

            return null;
        }
        // --- FONCTIONS D'IMPORT/EXPORT CSV ---

/**
 * 1. G√©n√®re une cha√Æne CSV contenant toutes les donn√©es de configuration.
 */
function generateCsvData() {
    const data = {
        nameA: document.getElementById('nameA').value,
        nameB: document.getElementById('nameB').value,
        refDate: document.getElementById('refDate').value,
        weeksA: document.getElementById('weeksA').value,
        weeksB: document.getElementById('weeksB').value,
        startParent: document.getElementById('startParent').value,
        colorA: document.getElementById('colorA').value,
        colorB: document.getElementById('colorB').value,
        colorVA: document.getElementById('colorVA').value,
        colorVB: document.getElementById('colorVB').value,
        schoolYearStart: document.getElementById('schoolYearStart').value,
        
        // S√©rialisation des vacances: [start|end|parent]
        holidays: holidays.map(h => 
            `${h.start.toISOString().split('T')[0]}|${h.end.toISOString().split('T')[0]}|${h.firstHalfParent}`
        ).join(';')
    };

    // Cr√©ation de l'en-t√™te et des valeurs pour le CSV
    const headers = Object.keys(data).join(',');
    const values = Object.values(data).map(v => `"${v}"`).join(','); // Encapsule les valeurs dans des guillemets
    
    return headers + '\n' + values;
}

/**
 * 2. Exporte les donn√©es de configuration dans un fichier CSV t√©l√©chargeable.
 */
function exportConfig() {
    const csvContent = generateCsvData();
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    
    // Cr√©e un nom de fichier unique bas√© sur la date
    const date = new Date().toISOString().split('T')[0];
    link.setAttribute('href', URL.createObjectURL(blob));
    link.setAttribute('download', `calendrier_garde_config_${date}.csv`);
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

/**
 * 3. Importe la configuration √† partir d'un fichier CSV s√©lectionn√© par l'utilisateur.
 */
function importConfig() {
    const fileInput = document.getElementById('importFile');
    const file = fileInput.files[0];
    
    if (!file) {
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const lines = e.target.result.trim().split('\n');
            if (lines.length < 2) throw new Error("Format de fichier invalide.");

            const headers = lines[0].split(',');
            const values = lines[1].match(/"([^"]*)"/g).map(v => v.replace(/"/g, '')); // Extraction des valeurs entre guillemets
            
            if (headers.length !== values.length) throw new Error("Incoh√©rence entre les en-t√™tes et les valeurs.");

            const config = {};
            headers.forEach((h, i) => {
                config[h.trim()] = values[i];
            });
            
            // 4. Application des valeurs dans l'interface
            document.getElementById('nameA').value = config.nameA;
            document.getElementById('nameB').value = config.nameB;
            document.getElementById('refDate').value = config.refDate;
            document.getElementById('weeksA').value = config.weeksA;
            document.getElementById('weeksB').value = config.weeksB;
            document.getElementById('startParent').value = config.startParent;
            document.getElementById('colorA').value = config.colorA;
            document.getElementById('colorB').value = config.colorB;
            document.getElementById('colorVA').value = config.colorVA;
            document.getElementById('colorVB').value = config.colorVB;
            document.getElementById('schoolYearStart').value = config.schoolYearStart;
            
            // 5. R√©hydratation des vacances
            holidays = [];
            if (config.holidays) {
                const holidayStrings = config.holidays.split(';');
                holidayStrings.forEach((str, index) => {
                    if (str) {
                         const parts = str.split('|');
                         if (parts.length === 3) {
                             const startDate = new Date(parts[0] + 'T00:00:00');
                             const endDate = new Date(parts[1] + 'T00:00:00');
                             const durationDays = Math.floor((endDate.getTime() - startDate.getTime()) / MS_PER_DAY) + 1;
                             const midDate = new Date(startDate.getTime() + Math.ceil(durationDays / 2) * MS_PER_DAY);
                             
                             holidays.push({
                                 start: startDate,
                                 end: endDate,
                                 mid: midDate,
                                 firstHalfParent: parts[2],
                                 id: Date.now() + index // Utilise l'index pour garantir l'unicit√©
                             });
                         }
                    }
                });
            }

            // 6. Mise √† jour de l'interface et du calendrier
            renderHolidayList(); // Affiche la liste des vacances import√©es
            initCalendar(); // (Appelle updateNames() et changeColor())
            alert("Configuration import√©e avec succ√®s !");

        } catch (error) {
            console.error("Erreur lors de l'importation:", error);
            alert("Erreur lors de l'importation du fichier. Veuillez v√©rifier le format du CSV.");
        }
    };
    
    reader.readAsText(file);
}
        /**
 * D√©termine √† quel parent appartient la date donn√©e, en tenant compte des vacances
 * et en compensant les semaines incompl√®tes.
 */
function getParent(date, refDate, startParentClass) {
    // 1. Priorit√© absolue aux vacances
    const holidayOverride = getHolidayOverride(date);
    if (holidayOverride) {
        return holidayOverride;
    }

    // 2. R√©cup√©rer les param√®tres du cycle
    const weeksA = parseInt(document.getElementById('weeksA').value) || 1;
    const weeksB = parseInt(document.getElementById('weeksB').value) || 1;
    const daysA = weeksA * 7;
    const cycleLengthDays = daysA + (weeksB * 7);

    // --- LOGIQUE DE COMPENSATION ---

    const dateTimestamp = new Date(date.getFullYear(), date.getMonth(), date.getDate()).getTime();

    let actualRefDate = new Date(refDate.getTime());
    let actualStartParentClass = startParentClass;

    // Trouver la derni√®re fin de vacances avant la date actuelle
    let lastHolidayEndInfo = null;
    let maxEndTimestamp = -1;

    for (const h of holidays) {
        // La fin des vacances doit √™tre ant√©rieure √† la date actuelle
        if (h.end.getTime() < dateTimestamp && h.end.getTime() > maxEndTimestamp) {
            lastHolidayEndInfo = h;
            maxEndTimestamp = h.end.getTime();
        }
    }
    
    // Si nous trouvons une p√©riode de vacances pass√©e
    if (lastHolidayEndInfo) {
        
        // Date de reprise: le jour suivant la fin des vacances
        const restartDate = new Date(lastHolidayEndInfo.end.getTime() + MS_PER_DAY);
        
        // --- 2. D√©termination de la compensation ---
        
        // Le jour avant le d√©but des vacances (le point d'interruption)
        const dayBeforeHoliday = new Date(lastHolidayEndInfo.start.getTime() - MS_PER_DAY);
        
        // Quel √©tait le statut du cycle standard le jour avant l'interruption ?
        const infoBeforeHoliday = getStandardCycleParent(dayBeforeHoliday, refDate, startParentClass);
        const parentBeforeHoliday = infoBeforeHoliday.class; // parent-a ou parent-b
        
        // Nombre total de jours du cycle que le parent interrompu devait avoir
        const parentCycleDays = (parentBeforeHoliday === 'parent-a') ? daysA : (weeksB * 7);
        
        // Nombre de jours que ce parent a d√©j√† eu avant l'interruption :
        // On se base sur le cycle initial.
        const diffDaysToRef = Math.floor((dayBeforeHoliday.getTime() - refDate.getTime()) / MS_PER_DAY);
        let dayInCycle = diffDaysToRef % cycleLengthDays;
        if (dayInCycle < 0) dayInCycle += cycleLengthDays;

        // Si le Parent A est le parent interrompu (standard A = jours 0 √† daysA-1)
        if (parentBeforeHoliday === 'parent-a') {
            // Le jour de l'interruption (diffDaysToRef) est dans le cycle de A.
            // On calcule combien de jours il reste au Parent A dans son cycle de daysA jours.
            
            let parentStartDayInCycle = 0;
            if (actualStartParentClass === 'parent-b') {
                parentStartDayInCycle = daysA;
            }
            
            // Si le cycle a √©t√© invers√© par startParentClass
            let dayInParentCycle;
            if (startParentClass === 'parent-a') {
                 dayInParentCycle = dayInCycle; // Si dans la p√©riode A (0 √† daysA-1)
            } else {
                 dayInParentCycle = dayInCycle - daysA; // Si dans la p√©riode B (daysA √† cycleLengthDays-1)
            }
            
            // R√©cup√©rer le jour par rapport au d√©but du cycle du parent (0-based)
            if (dayInCycle >= 0 && dayInCycle < daysA) {
                // Parent A standard
                dayInParentCycle = dayInCycle;
            } else {
                // Parent B standard
                 dayInParentCycle = dayInCycle - daysA;
            }

            // On compense si le cycle a √©t√© interrompu DANS la p√©riode d'un parent (jour < jours total)
            const daysRemaining = parentCycleDays - (dayInParentCycle + 1); // +1 car 0-based

            if (daysRemaining > 0) {
                // Le parent interrompu doit reprendre pour r√©cup√©rer les jours manqu√©s.
                // On reprend avec le parent qui avait la garde avant les vacances,
                // mais on d√©cale le point de d√©part du cycle standard.
                
                // Calculer le d√©calage pour que la REPRISE standard commence le cycle du parent
                // qui a √©t√© interrompu et lui laisse le temps de finir sa p√©riode.
                
                // La nouvelle date de r√©f√©rence doit √™tre la date de reprise,
                // et le parent qui commence le cycle √† cette date est le parent interrompu.
                
                actualRefDate = restartDate;
                actualStartParentClass = parentBeforeHoliday;

            } else {
                // Si daysRemaining est <= 0, le parent interrompu a termin√© sa p√©riode
                // le jour avant les vacances, ou aurait d√ª la finir.
                // Le cycle doit donc reprendre avec le parent INVERSE
                
                const lastHolidayParentClass = (lastHolidayEndInfo.firstHalfParent === 'parent-a' ? 'parent-b' : 'parent-a');

                actualRefDate = restartDate;
                actualStartParentClass = (lastHolidayParentClass === 'parent-a' ? 'parent-b' : 'parent-a');
            }
        }
    }

    // 3. Calculer la garde standard avec la r√©f√©rence potentiellement d√©cal√©e
    
    // Si un d√©calage a √©t√© calcul√©, on le r√©utilise pour le calcul standard.
    // Sinon, on utilise la r√©f√©rence initiale.
    return getStandardCycleParent(date, actualRefDate, actualStartParentClass);
}

// NOTE: La fonction getStandardCycleParent est suppos√©e √™tre la m√™me que pr√©c√©demment,
// elle calcule le parent en fonction d'une date de r√©f√©rence (lundi) et d'un parent de d√©part.
// Il n'est pas n√©cessaire de la modifier.
        
        // --- GESTION DES VACANCES ---

        function addHoliday() {
            const startInput = document.getElementById('holiday-start');
            const endInput = document.getElementById('holiday-end');
            const parentInput = document.getElementById('holiday-parent');

            const startDate = new Date(startInput.value + 'T00:00:00');
            const endDate = new Date(endInput.value + 'T00:00:00');
            const firstHalfParent = parentInput.value;

            if (!startInput.value || !endInput.value || startDate > endDate) {
                alert("Veuillez saisir des dates de d√©but et de fin valides (D√©but <= Fin).");
                return;
            }
            
            const durationDays = Math.floor((endDate.getTime() - startDate.getTime()) / MS_PER_DAY) + 1;
            const midDayOffset = Math.ceil(durationDays / 2); 
            
            const midDate = new Date(startDate.getTime() + (midDayOffset) * MS_PER_DAY);

            holidays.push({
                start: startDate,
                end: endDate,
                mid: midDate,
                firstHalfParent: firstHalfParent,
                id: Date.now()
            });

            startInput.value = '';
            endInput.value = '';
            
            renderHolidayList();
            renderCalendar(); 
            if(document.getElementById('full-year-view').style.display !== 'none') {
                renderSchoolYear();
            }
        }

        function removeHoliday(id) {
            holidays = holidays.filter(h => h.id !== id);
            renderHolidayList();
            renderCalendar();
             if(document.getElementById('full-year-view').style.display !== 'none') {
                renderSchoolYear();
            }
        }

        function renderHolidayList() {
            const listDiv = document.getElementById('holiday-list');
            listDiv.innerHTML = '';

            if (holidays.length === 0) {
                 listDiv.innerHTML = '<p>Aucune p√©riode de vacances d√©finie.</p>';
                 return;
            }

            holidays.sort((a, b) => a.start - b.start).forEach(h => {
                const startStr = h.start.toLocaleDateString('fr-FR');
                const endStr = h.end.toLocaleDateString('fr-FR');
                const endHalf1 = new Date(h.mid.getTime() - MS_PER_DAY).toLocaleDateString('fr-FR');
                
                const parentName1 = (h.firstHalfParent === 'parent-a' ? document.getElementById('nameA').value : document.getElementById('nameB').value) || 'Parent 1';
                const parentName2 = (h.firstHalfParent === 'parent-a' ? document.getElementById('nameB').value : document.getElementById('nameA').value) || 'Parent 2';

                const item = document.createElement('p');
                item.classList.add('holiday-list-item');
                item.innerHTML = `
                    <span style="font-weight: bold;">${startStr}</span> au <span style="font-weight: bold;">${endStr}</span> : 
                    ${parentName1} jusqu'au ${endHalf1}, puis 
                    ${parentName2} √† partir du ${h.mid.toLocaleDateString('fr-FR')}.
                    <button onclick="removeHoliday(${h.id})" style="margin-left: 10px; color: #e74c3c; border: none; background: none; cursor: pointer; font-size: 14px;">(X)</button>
                `;
                listDiv.appendChild(item);
            });
        }
        
        function updateNames() {
    const nameA = document.getElementById('nameA').value || 'Parent A';
    const nameB = document.getElementById('nameB').value || 'Parent B';
    
    // --- Mise √† jour de la L√©gende ---
    document.getElementById('legend-name-a').textContent = `${nameA} (standard)`;
    document.getElementById('legend-name-b').textContent = `${nameB} (standard)`;
    document.getElementById('legend-vac-a').textContent = `${nameA} (vacances)`;
    document.getElementById('legend-vac-b').textContent = `${nameB} (vacances)`;

    document.getElementById('opt-parent-a').textContent = nameA;
    document.getElementById('opt-parent-b').textContent = nameB;

    const holidayParentSelect = document.getElementById('holiday-parent');
    holidayParentSelect.options[0].textContent = nameA;
    holidayParentSelect.options[1].textContent = nameB;

    // --- Mise √† jour des libell√©s de Couleur (avec IDs) ---
    document.getElementById('label-colorA').textContent = `Couleur ${nameA} :`;
    document.getElementById('label-colorB').textContent = `Couleur ${nameB} :`;
    document.getElementById('label-colorVA').textContent = `Couleur Vacances ${nameA} :`;
    document.getElementById('label-colorVB').textContent = `Couleur Vacances ${nameB} :`;

    renderHolidayList();
    renderCalendar();
    if(document.getElementById('full-year-view').style.display !== 'none') {
        renderSchoolYear();
    }
}
        
        function changeColor() {
            const root = document.documentElement;
            
            const colorA = document.getElementById('colorA').value;
            const colorB = document.getElementById('colorB').value;
            const colorVA = document.getElementById('colorVA').value;
            const colorVB = document.getElementById('colorVB').value;

            // Changement des couleurs de fond standard
            root.style.setProperty('--color-a-bg', colorA);
            root.style.setProperty('--color-b-bg', colorB);
            
            // Changement des couleurs de fond et bordure des vacances
            root.style.setProperty('--color-va-bg', colorVA);
            root.style.setProperty('--color-vb-bg', colorVB);
            
            // Les bordures des vacances prennent la couleur de fond
            root.style.setProperty('--color-va-border', colorVA);
            root.style.setProperty('--color-vb-border', colorVB);
            
            // Rafra√Æchir l'affichage
            if(document.getElementById('full-year-view').style.display !== 'none') {
                renderSchoolYear();
            } else {
                renderCalendar();
            }
        }
        
        /**
         * Masque ou affiche le panneau de configuration en modifiant la propri√©t√© display.
         */
        function toggleConfig() {
            const configPanel = document.getElementById('config-panel');
            const calendarDisplay = document.querySelector('.calendar-display');
            
            // V√©rifie si le panneau est actuellement visible (display n'est pas 'none')
            const isVisible = configPanel.style.display !== 'none';
        
            if (isVisible) {
                // Masquer le panneau
                configPanel.style.display = 'none';
                
                // Optionnel : Permettre au calendrier d'occuper toute la largeur
                // On supprime la contrainte de largeur pour le calendrier
                calendarDisplay.style.maxWidth = '100%'; 
                
            } else {
                // Afficher le panneau
                configPanel.style.display = 'block';
                
                // R√©tablir la largeur maximale par d√©faut (pour la disposition √† deux colonnes)
                calendarDisplay.style.maxWidth = '950px'; // R√©ajuster √† la taille souhait√©e si n√©cessaire
            }
        }

        // --- GESTION DES VUES CALENDRIER ---

        function generateMonthHtml(month, year) {
            const refDateInput = document.getElementById('refDate');
            const startParentSelect = document.getElementById('startParent');
            const refDate = new Date(refDateInput.value + 'T00:00:00'); 
            const startParentClass = startParentSelect.value;
            
            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            
            let startOffset = firstDayOfMonth.getDay(); 
            if (startOffset === 0) startOffset = 7; 
            startOffset = startOffset - 1; 

            let date = 1;
            let html = '';

            for (let i = 0; i < 6; i++) { 
                let row = '<tr>';
                let hasRealDay = false; 

                for (let j = 0; j < 7; j++) {
                    let cellClasses = '';
                    let cellContent = '';
                    let titleAttribute = '';
                    
                    if (i === 0 && j < startOffset) {
                        cellClasses = 'out-of-month';
                    } else if (date > lastDayOfMonth.getDate()) {
                        cellClasses = 'out-of-month';
                    } else {
                        const currentDate = new Date(year, month, date);
                        const parentInfo = getParent(currentDate, refDate, startParentClass);
                        
                        cellContent = date;
                        cellClasses = parentInfo.class;
                        titleAttribute = `title="${parentInfo.name}"`;
                        
                        date++;
                        hasRealDay = true;
                    }
                    row += `<td class="${cellClasses}" ${titleAttribute}>${cellContent}</td>`;
                }
                row += '</tr>';
                
                if (hasRealDay) {
                    html += row;
                }
                
                if (date > lastDayOfMonth.getDate()) {
                    break; 
                }
            }
            return html;
        }

        function toggleView(mode) {
            const singleView = document.getElementById('single-month-view');
            const fullYearView = document.getElementById('full-year-view');

            if (mode === 'single') {
                singleView.style.display = 'block';
                fullYearView.style.display = 'none';
                renderCalendar(); 
            } else if (mode === 'full') {
                singleView.style.display = 'none';
                fullYearView.style.display = 'grid'; 
            }
        }
        
        function renderSchoolYear() {
            const container = document.getElementById('full-year-view');
            container.innerHTML = '';
            
            const startYear = parseInt(document.getElementById('schoolYearStart').value);
            const endYear = startYear + 1;
            
            let currentYearLoop = startYear;
            let currentMonthLoop = 6; // Juillet (0=Jan, 6=Juil)
            
            for (let i = 0; i < 14; i++) { // 14 mois (Juillet X √† Ao√ªt X+1)
                
                if (currentMonthLoop > 11) {
                    currentMonthLoop = 0;
                    currentYearLoop = endYear;
                }
                
                const tbodyHtml = generateMonthHtml(currentMonthLoop, currentYearLoop);
                
                const monthDate = new Date(currentYearLoop, currentMonthLoop, 1);
                const monthName = monthDate.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
                const capitalizedMonthName = monthName.charAt(0).toUpperCase() + monthName.slice(1);
                
                const monthTable = document.createElement('table');
                monthTable.classList.add('month-calendar');
                monthTable.innerHTML = `
                    <caption>${capitalizedMonthName}</caption>
                    <thead>
                        <tr>
                            <th>Lun</th><th>Mar</th><th>Mer</th><th>Jeu</th><th>Ven</th><th>Sam</th><th>Dim</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tbodyHtml}
                    </tbody>
                `;
                
                container.appendChild(monthTable);
                currentMonthLoop++;
            }
            
            toggleView('full'); 
        }

        function renderCalendar() {
            const body = document.getElementById('calendar-body');
            const monthYearText = document.getElementById('month-year');
            
            const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
            const monthName = firstDayOfMonth.toLocaleDateString('fr-FR', { month: 'long' });
            monthYearText.textContent = `${monthName.charAt(0).toUpperCase() + monthName.slice(1)} ${currentYear}`;
            
            body.innerHTML = generateMonthHtml(currentMonth, currentYear);
        }

        function changeMonth(delta) {
            currentMonth += delta;
            
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            } else if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            
            renderCalendar();
        }

        // --- Initialisation ---

        function updateSchoolYearStartDefault() {
            const today = new Date();
            const currentMonth = today.getMonth(); // 0-11
            let defaultYear = today.getFullYear();
            
            // Si on est entre Janvier et Juin (0 √† 5), l'ann√©e scolaire de d√©part est l'ann√©e pr√©c√©dente
            if (currentMonth >= 0 && currentMonth <= 5) {
                defaultYear = defaultYear - 1;
            }
            
            document.getElementById('schoolYearStart').value = defaultYear;
        }

        function initCalendar() {
            // L'ordre est important ici
            updateNames(); 
            changeColor(); 
        }
        
        updateSchoolYearStartDefault();
        initCalendar();
    </script>

</body>
</html>
